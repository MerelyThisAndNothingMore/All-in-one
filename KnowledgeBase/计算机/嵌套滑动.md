---
tags: 
alias:
---

# 定义

**嵌套滑动（Nested Scrolling）** 是 Android 提供的一种机制，允许子视图和父视图在处理滚动事件时协作。嵌套滑动主要用于处理复杂的滚动场景，例如在一个可以滚动的父布局中嵌套另一个可以滚动的子布局。通过嵌套滑动，可以避免滚动冲突，提升用户体验。

## 特点

1. **父子视图协作**：
   - 子视图和父视图可以协同工作，共享滚动事件，提高滚动处理的灵活性和一致性。

2. **滚动优先级**：
   - 支持灵活的滚动优先级设置，可以根据需要调整父视图和子视图的滚动行为。

3. **向前兼容**：
   - 嵌套滑动机制向前兼容，可以在较旧版本的 Android 系统上使用嵌套滑动功能。

4. **丰富的接口**：
   - 提供了一系列接口和方法，便于开发者实现自定义的滚动行为和处理逻辑。

## 相似概念辨析

1. **嵌套滑动 vs 普通滑动**：
   - 普通滑动是指单个视图的滚动处理，嵌套滑动则是多个视图之间的滚动协调。
   
2. **嵌套滑动 vs 嵌套滚动视图**：
   - 嵌套滚动视图（如 `NestedScrollView`）是特定实现嵌套滑动的视图，嵌套滑动则是一个通用机制，支持在任意视图之间实现滚动协作。

3. **嵌套滑动 vs 嵌套滚动机制**：
   - 嵌套滑动是一种实现嵌套滚动机制的方式，嵌套滚动机制则是更广泛的概念，涵盖了多种实现方式。

# 原理

嵌套滑动通过定义一组接口和方法，实现父子视图之间的滚动事件传递和处理。主要涉及以下几个接口和类：

1. **NestedScrollingChild**：
   - 子视图实现该接口，表示其支持嵌套滑动，可以向父视图请求滚动事件。

2. **NestedScrollingParent**：
   - 父视图实现该接口，表示其支持嵌套滑动，可以处理子视图的滚动请求。

3. **NestedScrollingChildHelper** 和 **NestedScrollingParentHelper**：
   - 辅助类，简化嵌套滑动接口的实现，处理滚动事件的传递和协调。

# 使用

1. **子视图实现 NestedScrollingChild**：
   - 在子视图中实现 `NestedScrollingChild` 接口，或直接使用实现了该接口的视图，如 `RecyclerView`。
   
   ```java
   public class NestedChildView extends View implements NestedScrollingChild {
       private NestedScrollingChildHelper nestedScrollingChildHelper;

       public NestedChildView(Context context) {
           super(context);
           nestedScrollingChildHelper = new NestedScrollingChildHelper(this);
           setNestedScrollingEnabled(true);
       }

       @Override
       public boolean startNestedScroll(int axes) {
           return nestedScrollingChildHelper.startNestedScroll(axes);
       }

       @Override
       public void stopNestedScroll() {
           nestedScrollingChildHelper.stopNestedScroll();
       }

       @Override
       public boolean hasNestedScrollingParent() {
           return nestedScrollingChildHelper.hasNestedScrollingParent();
       }

       @Override
       public boolean dispatchNestedScroll(int dxConsumed, int dyConsumed,
                                           int dxUnconsumed, int dyUnconsumed, int[] offsetInWindow) {
           return nestedScrollingChildHelper.dispatchNestedScroll(dxConsumed, dyConsumed,
                   dxUnconsumed, dyUnconsumed, offsetInWindow);
       }

       // 其他方法实现...
   }
   ```

2. **父视图实现 NestedScrollingParent**：
   - 在父视图中实现 `NestedScrollingParent` 接口，处理子视图的滚动请求。
   
   ```java
   public class NestedParentView extends ViewGroup implements NestedScrollingParent {
       private NestedScrollingParentHelper nestedScrollingParentHelper;

       public NestedParentView(Context context) {
           super(context);
           nestedScrollingParentHelper = new NestedScrollingParentHelper(this);
       }

       @Override
       public boolean onStartNestedScroll(View child, View target, int nestedScrollAxes) {
           return true; // 确定是否支持嵌套滚动
       }

       @Override
       public void onNestedScrollAccepted(View child, View target, int nestedScrollAxes) {
           nestedScrollingParentHelper.onNestedScrollAccepted(child, target, nestedScrollAxes);
       }

       @Override
       public void onStopNestedScroll(View target) {
           nestedScrollingParentHelper.onStopNestedScroll(target);
       }

       @Override
       public void onNestedScroll(View target, int dxConsumed, int dyConsumed,
                                  int dxUnconsumed, int dyUnconsumed) {
           // 处理嵌套滚动
       }

       @Override
       public void onNestedPreScroll(View target, int dx, int dy, int[] consumed) {
           // 处理嵌套预滚动
       }

       // 其他方法实现...
   }
   ```

3. **使用嵌套滚动视图**：
   - 使用系统提供的支持嵌套滑动的视图，如 `NestedScrollView` 和 `CoordinatorLayout`。
   
   ```xml
   <androidx.core.widget.NestedScrollView
       android:layout_width="match_parent"
       android:layout_height="match_parent">

       <LinearLayout
           android:layout_width="match_parent"
           android:layout_height="wrap_content"
           android:orientation="vertical">

           <!-- 滚动内容 -->

       </LinearLayout>
   </androidx.core.widget.NestedScrollView>
   ```

# 示例

以下是一个使用嵌套滑动实现父子视图协同滚动的示例：

```java
public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        NestedParentView parentView = findViewById(R.id.parent_view);
        NestedChildView childView = findViewById(R.id.child_view);

        // 设置嵌套滑动
        childView.setNestedScrollingEnabled(true);
    }
}
```

# Q & A

1. **什么是嵌套滑动？**
   - 嵌套滑动是 Android 提供的一种机制，允许子视图和父视图在处理滚动事件时协作，以避免滚动冲突和提升用户体验。

2. **如何实现嵌套滑动？**
   - 子视图实现 `NestedScrollingChild` 接口，父视图实现 `NestedScrollingParent` 接口，或者使用系统提供的支持嵌套滑动的视图。

3. **嵌套滑动的主要优点是什么？**
   - 解决复杂的滚动场景，避免滚动冲突，提高滚动处理的灵活性和一致性。

4. **哪些视图支持嵌套滑动？**
   - `RecyclerView`、`NestedScrollView`、`CoordinatorLayout` 等视图都支持嵌套滑动。

通过理解 Android 中嵌套滑动的定义、特点、原理和实际应用，可以更好地设计和实现复杂的滚动界面，提供流畅的用户体验。
