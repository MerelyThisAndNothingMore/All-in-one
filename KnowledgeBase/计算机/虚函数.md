---
tags: 
alias:
---

# 定义

虚函数（Virtual Function）是[[面向对象]]编程中一种允许子类重写的成员函数。虚函数在基类中使用 `virtual` 关键字声明，目的是在运行时通过多态性机制，动态决定调用哪一个类的实现。在 C++ 和其他面向对象的语言中，虚函数使得程序能够在运行时选择最合适的函数版本，而不是在编译时就确定。

#### 特点

1. **多态性**：
   - 通过虚函数实现多态性，允许基类指针或引用在运行时调用子类的实现。

2. **运行时动态绑定**：
   - 虚函数通过运行时动态绑定（或称为晚绑定、动态调度）机制实现，不同于非虚函数的编译时静态绑定。

3. **虚函数表**：
   - 编译器通常会为包含虚函数的类创建一个虚函数表（vtable），用于在运行时确定实际调用的函数。

4. **基类和派生类**：
   - 虚函数在基类中声明，在派生类中可以选择性地重写，以提供具体实现。

#### 相似概念辨析

1. **虚函数 vs 普通函数**：
   - 普通函数在编译时进行静态绑定，调用哪个函数在编译时就已经确定，而虚函数在运行时进行动态绑定，调用哪个函数由对象的实际类型决定。

2. **虚函数 vs 纯虚函数**：
   - 纯虚函数是虚函数的一种特殊形式，基类中声明纯虚函数意味着基类不能实例化，子类必须重写纯虚函数。纯虚函数的声明形式为 `virtual void function() = 0;`。

3. **虚函数 vs 抽象方法**：
   - 抽象方法是其他编程语言（如 Java、C#）中的类似概念，指在抽象类中定义的没有实现的方法，子类必须重写这些方法。虚函数可以有默认实现，而抽象方法不能。

#### 原理

虚函数的原理基于虚函数表（vtable）和指向该表的指针（vptr）。以下是虚函数工作的基本原理：

1. **虚函数表（vtable）**：
   - 编译器为每个包含虚函数的类创建一个虚函数表，表中包含指向各个虚函数实现的指针。

2. **虚函数表指针（vptr）**：
   - 每个对象包含一个指向其对应类的虚函数表的指针。这个指针在对象创建时初始化，指向正确的虚函数表。

3. **动态绑定**：
   - 在运行时，通过对象的虚函数表指针查找实际要调用的函数，实现动态绑定。

#### 使用

虚函数在面向对象编程中有广泛的应用，特别是在需要多态性和动态绑定的场景中。以下是一些常见的使用场景：

1. **接口和多态性**：
   - 通过虚函数定义接口，实现不同子类的多态性行为。
   
   ```cpp
   class Base {
   public:
       virtual void display() {
           std::cout << "Base display" << std::endl;
       }
   };

   class Derived : public Base {
   public:
       void display() override {
           std::cout << "Derived display" << std::endl;
       }
   };
   
   Base* obj = new Derived();
   obj->display(); // 输出 "Derived display"
   ```

2. **动态方法选择**：
   - 使用虚函数实现动态方法选择，根据对象的实际类型调用合适的方法。

3. **抽象类和纯虚函数**：
   - 通过纯虚函数定义抽象类，强制子类实现特定接口。

   ```cpp
   class Abstract {
   public:
       virtual void pureVirtualFunction() = 0; // 纯虚函数
   };

   class Concrete : public Abstract {
   public:
       void pureVirtualFunction() override {
           std::cout << "Concrete implementation" << std::endl;
       }
   };
   ```

#### Q & A

1. **为什么要使用虚函数？**
   - 虚函数允许子类提供特定实现，从而实现多态性，支持动态绑定，使得程序更加灵活和可扩展。

2. **虚函数如何实现动态绑定？**
   - 通过虚函数表和虚函数表指针实现动态绑定。在运行时，通过对象的虚函数表指针查找并调用实际的函数。

3. **什么是纯虚函数？**
   - 纯虚函数是没有实现的虚函数，在基类中声明纯虚函数，表示基类是抽象类，子类必须重写这些函数。

4. **虚函数的性能开销大吗？**
   - 虚函数的动态绑定在运行时会有一定的性能开销，因为需要通过虚函数表查找函数指针。但这通常是可以接受的，因为带来的灵活性和可扩展性往往超过了性能损失。

通过理解虚函数的定义、特点、原理和实际应用，可以在面向对象编程中灵活地使用虚函数，编写更具扩展性和可维护性的代码。